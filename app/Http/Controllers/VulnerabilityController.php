<?php

namespace App\Http\Controllers;

use App\Models\Project;
use App\Models\ProjectVulnerability;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Http\Request;
use Illuminate\View\View;

class VulnerabilityController extends Controller
{
    public function index(Request $request): View
    {
        $projectIds = Project::query()
            ->whereHas('teams.users', function (Builder $query) use ($request): void {
                $query->whereKey($request->user()->getKey());
            })
            ->pluck('projects.id');

        $severity = $request->string('severity')->toString();
        $ecosystem = $request->string('ecosystem')->toString();
        $source = $request->string('source')->toString();
        $hasFix = $request->string('has_fix')->toString();
        $search = $request->string('search')->toString();

        $baseQuery = ProjectVulnerability::query()
            ->select([
                'id',
                'project_id',
                'osv_url',
                'cvss_score',
                'ecosystem',
                'package_name',
                'version',
                'fixed_version',
                'source',
                'ingested_at',
            ])
            ->with('project:id,name')
            ->whereIn('project_id', $projectIds);

        $vulnerabilities = (clone $baseQuery)
            ->when($severity !== '', function (Builder $query) use ($severity): void {
                match ($severity) {
                    'critical' => $query->where('cvss_score', '>=', 9.0),
                    'high' => $query->where('cvss_score', '>=', 7.0)->where('cvss_score', '<', 9.0),
                    'medium' => $query->where('cvss_score', '>=', 4.0)->where('cvss_score', '<', 7.0),
                    'low' => $query->where(function (Builder $subQuery): void {
                        $subQuery->where('cvss_score', '<', 4.0)
                            ->orWhereNull('cvss_score');
                    }),
                    default => null,
                };
            })
            ->when($ecosystem !== '', fn (Builder $query) => $query->where('ecosystem', $ecosystem))
            ->when($source !== '', fn (Builder $query) => $query->where('source', $source))
            ->when($hasFix === 'yes', fn (Builder $query) => $query->whereNotNull('fixed_version'))
            ->when($hasFix === 'no', fn (Builder $query) => $query->whereNull('fixed_version'))
            ->when($search !== '', function (Builder $query) use ($search): void {
                $query->whereRaw('LOWER(package_name) LIKE ?', ['%'.strtolower($search).'%']);
            })
            ->orderByRaw('CASE
                WHEN cvss_score >= 9.0 THEN 4
                WHEN cvss_score >= 7.0 THEN 3
                WHEN cvss_score >= 4.0 THEN 2
                ELSE 1
            END DESC')
            ->orderByDesc('cvss_score')
            ->orderBy('package_name')
            ->orderBy('id')
            ->paginate(20)
            ->withQueryString();

        $ecosystems = (clone $baseQuery)
            ->select('ecosystem')
            ->distinct()
            ->orderBy('ecosystem')
            ->pluck('ecosystem');

        $sources = (clone $baseQuery)
            ->select('source')
            ->distinct()
            ->orderBy('source')
            ->pluck('source');

        return view('vulnerabilities.index', [
            'vulnerabilities' => $vulnerabilities,
            'ecosystems' => $ecosystems,
            'sources' => $sources,
            'filters' => [
                'severity' => $severity,
                'ecosystem' => $ecosystem,
                'source' => $source,
                'has_fix' => $hasFix,
                'search' => $search,
            ],
        ]);
    }

    public function show(ProjectVulnerability $vulnerability): View
    {
        $vulnerability->load('project');
        $this->authorize('view', $vulnerability->project);

        return view('vulnerabilities.show', [
            'vulnerability' => $vulnerability,
        ]);
    }
}
