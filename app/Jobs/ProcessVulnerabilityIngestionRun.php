<?php

namespace App\Jobs;

use App\Models\IngestionRun;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Queue\Queueable;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class ProcessVulnerabilityIngestionRun implements ShouldQueue
{
    use Queueable;

    public int $tries;

    public int $maxExceptions = 3;

    /**
     * Create a new job instance.
     */
    public function __construct(
        public string $ingestionRunId,
        public string $source,
        public string $ingestedAt,
        public array $vulnerabilities,
    ) {
        $this->tries = (int) config('queue.worker.tries', 5);
    }

    /**
     * @return array<int, int>
     */
    public function backoff(): array
    {
        /** @var array<int, int> $backoff */
        $backoff = config('queue.worker.backoff', [1, 5, 10]);

        return $backoff;
    }

    /**
     * Execute the job.
     */
    public function handle(): void
    {
        $ingestionRun = IngestionRun::query()->find($this->ingestionRunId);

        if ($ingestionRun === null || $ingestionRun->processed_at !== null) {
            return;
        }

        DB::transaction(function () use ($ingestionRun): void {
            DB::table('project_vulnerabilities')
                ->where('project_id', $ingestionRun->project_id)
                ->where('source', strtolower(trim($this->source)))
                ->delete();

            $rows = array_map(function (array $vulnerability) use ($ingestionRun): array {
                return [
                    'id' => (string) Str::uuid(),
                    'project_id' => $ingestionRun->project_id,
                    'osv_url' => trim((string) $vulnerability['osv_url']),
                    'cvss_score' => isset($vulnerability['cvss_score']) ? (float) $vulnerability['cvss_score'] : null,
                    'ecosystem' => strtolower(trim((string) $vulnerability['ecosystem'])),
                    'package_name' => trim((string) $vulnerability['package_name']),
                    'version' => trim((string) $vulnerability['version']),
                    'fixed_version' => isset($vulnerability['fixed_version']) && trim((string) $vulnerability['fixed_version']) !== ''
                        ? trim((string) $vulnerability['fixed_version'])
                        : null,
                    'source' => strtolower(trim($this->source)),
                    'ingested_at' => $this->ingestedAt,
                    'created_at' => now(),
                    'updated_at' => now(),
                ];
            }, $this->vulnerabilities);

            DB::table('project_vulnerabilities')->insert($rows);

            $ingestionRun->forceFill([
                'processed_at' => now(),
            ])->save();
        });
    }
}
