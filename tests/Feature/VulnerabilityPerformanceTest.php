<?php

use App\Models\Project;
use App\Models\Team;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Str;

function insertPerfVulnerability(Project $project, array $attributes = []): void
{
    DB::table('project_vulnerabilities')->insert(array_merge([
        'id' => (string) Str::orderedUuid(),
        'project_id' => $project->id,
        'osv_url' => 'https://osv.dev/PERF-1',
        'cvss_score' => 8.2,
        'ecosystem' => 'npm',
        'package_name' => 'shared-package',
        'version' => '1.0.0',
        'fixed_version' => null,
        'source' => 'osv',
        'ingested_at' => now(),
        'created_at' => now(),
        'updated_at' => now(),
    ], $attributes));
}

test('project vulnerabilities table contains performance indexes for dashboard and list filtering', function () {
    expect(Schema::hasIndex('project_vulnerabilities', ['project_id', 'cvss_score']))->toBeTrue();
    expect(Schema::hasIndex('project_vulnerabilities', ['project_id', 'fixed_version']))->toBeTrue();
    expect(Schema::hasIndex('project_vulnerabilities', ['project_id', 'package_name']))->toBeTrue();
    expect(Schema::hasIndex('project_vulnerabilities', ['project_id', 'ingested_at']))->toBeTrue();
});

test('vulnerability pagination remains deterministic with non-overlapping pages', function () {
    $user = User::factory()->create();
    $team = Team::factory()->create();
    $project = Project::factory()->create();
    $team->users()->attach($user->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    foreach (range(1, 25) as $index) {
        insertPerfVulnerability($project, [
            'version' => '1.0.'.$index,
        ]);
    }

    $pageOneResponse = $this->actingAs($user)->get(route('vulnerabilities.index'));
    $pageTwoResponse = $this->actingAs($user)->get(route('vulnerabilities.index', ['page' => 2]));

    $pageOneResponse->assertOk();
    $pageTwoResponse->assertOk();

    preg_match_all('/vulnerabilities\\/([a-f0-9\\-]{36})/i', $pageOneResponse->getContent(), $pageOneMatches);
    preg_match_all('/vulnerabilities\\/([a-f0-9\\-]{36})/i', $pageTwoResponse->getContent(), $pageTwoMatches);

    $pageOneIds = array_values(array_unique($pageOneMatches[1] ?? []));
    $pageTwoIds = array_values(array_unique($pageTwoMatches[1] ?? []));

    expect(count($pageOneIds))->toBe(20);
    expect(count($pageTwoIds))->toBe(5);
    expect(array_intersect($pageOneIds, $pageTwoIds))->toBe([]);
});
