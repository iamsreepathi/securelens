<?php

use App\Models\Project;
use App\Models\Team;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

function createDetailVulnerability(Project $project, array $attributes): string
{
    $id = (string) Str::uuid();

    DB::table('project_vulnerabilities')->insert(array_merge([
        'id' => $id,
        'project_id' => $project->id,
        'osv_url' => 'https://osv.dev/TEST-DETAIL',
        'cvss_score' => 8.4,
        'ecosystem' => 'npm',
        'package_name' => 'axios',
        'version' => '0.27.2',
        'fixed_version' => '1.6.0',
        'source' => 'osv',
        'ingested_at' => now(),
        'created_at' => now(),
        'updated_at' => now(),
    ], $attributes));

    return $id;
}

test('vulnerability details page shows remediation-relevant fields', function () {
    $user = User::factory()->create();
    $team = Team::factory()->create(['name' => 'AppSec']);
    $project = Project::factory()->create(['name' => 'Scanner']);
    $team->users()->attach($user->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    $vulnerabilityId = createDetailVulnerability($project, []);

    $response = $this->actingAs($user)->get(route('vulnerabilities.show', $vulnerabilityId));

    $response->assertOk();
    $response->assertSeeText('axios');
    $response->assertSeeText('Scanner');
    $response->assertSeeText('8.4');
    $response->assertSeeText('0.27.2');
    $response->assertSeeText('1.6.0');
    $response->assertSeeText('Open OSV Advisory');
    $response->assertSee('https://osv.dev/TEST-DETAIL', false);
});

test('vulnerability details access remains project scoped', function () {
    $owner = User::factory()->create();
    $outsider = User::factory()->create();
    $team = Team::factory()->create();
    $project = Project::factory()->create();
    $team->users()->attach($owner->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    $vulnerabilityId = createDetailVulnerability($project, []);

    $this->actingAs($outsider)
        ->get(route('vulnerabilities.show', $vulnerabilityId))
        ->assertForbidden();
});
