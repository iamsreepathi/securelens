<?php

use App\Http\Requests\Ingestion\StoreVulnerabilitySnapshotRequest;

test('openapi ingestion contract file is committed and includes auth and rate limit headers', function () {
    $path = base_path('openapi/v1/vulnerability-ingestion.yaml');

    expect(file_exists($path))->toBeTrue();

    $contract = file_get_contents($path);

    expect($contract)->toContain('openapi: 3.1.0');
    expect($contract)->toContain('/ingestion/vulnerabilities:');
    expect($contract)->toContain('BearerToken');
    expect($contract)->toContain('X-RateLimit-Limit');
    expect($contract)->toContain('X-RateLimit-Remaining');
    expect($contract)->toContain('X-RateLimit-Reset');
});

test('openapi ingestion contract aligns with request validation rule keys', function () {
    $request = new StoreVulnerabilitySnapshotRequest;
    $rules = $request->rules();

    expect(array_keys($rules))->toEqualCanonicalizing([
        'project_slug',
        'snapshot_id',
        'source',
        'ingested_at',
        'vulnerabilities',
        'vulnerabilities.*.osv_url',
        'vulnerabilities.*.cvss_score',
        'vulnerabilities.*.ecosystem',
        'vulnerabilities.*.package_name',
        'vulnerabilities.*.version',
        'vulnerabilities.*.fixed_version',
    ]);
});
