<?php

use App\Models\Project;
use App\Models\Team;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

function seedVulnerability(Project $project, array $attributes): void
{
    DB::table('project_vulnerabilities')->insert(array_merge([
        'id' => (string) Str::uuid(),
        'project_id' => $project->id,
        'osv_url' => 'https://osv.dev/TEST-1',
        'cvss_score' => 5.0,
        'ecosystem' => 'npm',
        'package_name' => 'demo-package',
        'version' => '1.0.0',
        'fixed_version' => null,
        'source' => 'osv',
        'ingested_at' => now(),
        'created_at' => now(),
        'updated_at' => now(),
    ], $attributes));
}

test('filter combinations return consistent vulnerability counts', function () {
    $user = User::factory()->create();
    $team = Team::factory()->create();
    $project = Project::factory()->create();
    $outsiderProject = Project::factory()->create();

    $team->users()->attach($user->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    seedVulnerability($project, [
        'package_name' => 'openssl-critical',
        'cvss_score' => 9.2,
        'ecosystem' => 'npm',
        'source' => 'osv',
        'fixed_version' => '1.0.1',
    ]);
    seedVulnerability($project, [
        'package_name' => 'openssl-high',
        'cvss_score' => 8.0,
        'ecosystem' => 'npm',
        'source' => 'osv',
        'fixed_version' => '1.1.0',
    ]);
    seedVulnerability($project, [
        'package_name' => 'requests-medium',
        'cvss_score' => 5.5,
        'ecosystem' => 'pypi',
        'source' => 'ghsa',
        'fixed_version' => null,
    ]);
    seedVulnerability($outsiderProject, [
        'package_name' => 'outsider-match',
        'cvss_score' => 8.5,
        'ecosystem' => 'npm',
        'source' => 'osv',
        'fixed_version' => '2.0.0',
    ]);

    $response = $this->actingAs($user)->get(route('vulnerabilities.index', [
        'severity' => 'high',
        'ecosystem' => 'npm',
        'source' => 'osv',
        'has_fix' => 'yes',
        'search' => 'openssl',
    ]));

    $response->assertOk();
    $response->assertSeeText('1 result');
    $response->assertSeeText('openssl-high');
    $response->assertDontSeeText('openssl-critical');
    $response->assertDontSeeText('requests-medium');
    $response->assertDontSeeText('outsider-match');
});

test('query string state restores exact vulnerability list view filters', function () {
    $user = User::factory()->create();
    $team = Team::factory()->create();
    $project = Project::factory()->create();

    $team->users()->attach($user->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    seedVulnerability($project, ['package_name' => 'openssl-high', 'cvss_score' => 8.0, 'fixed_version' => '1.1.0']);

    $response = $this->actingAs($user)->get(route('vulnerabilities.index', [
        'severity' => 'high',
        'ecosystem' => 'npm',
        'source' => 'osv',
        'has_fix' => 'yes',
        'search' => 'openssl',
    ]));

    $response->assertOk();
    $response->assertSee('name="search"', false);
    $response->assertSee('value="openssl"', false);
    $response->assertSee('option value="high" selected', false);
    $response->assertSee('option value="npm" selected', false);
    $response->assertSee('option value="osv" selected', false);
    $response->assertSee('option value="yes" selected', false);
});

test('vulnerability list sorts by severity then cvss descending', function () {
    $user = User::factory()->create();
    $team = Team::factory()->create();
    $project = Project::factory()->create();

    $team->users()->attach($user->id, ['role' => 'owner']);
    $project->teams()->attach($team->id, ['assigned_at' => now()]);

    seedVulnerability($project, ['package_name' => 'pkg-critical-1', 'cvss_score' => 9.8]);
    seedVulnerability($project, ['package_name' => 'pkg-critical-2', 'cvss_score' => 9.1]);
    seedVulnerability($project, ['package_name' => 'pkg-high', 'cvss_score' => 8.6]);
    seedVulnerability($project, ['package_name' => 'pkg-medium', 'cvss_score' => 5.4]);
    seedVulnerability($project, ['package_name' => 'pkg-low', 'cvss_score' => 2.0]);

    $response = $this->actingAs($user)->get(route('vulnerabilities.index'));

    $response->assertOk();
    $response->assertSeeInOrder([
        'pkg-critical-1',
        'pkg-critical-2',
        'pkg-high',
        'pkg-medium',
        'pkg-low',
    ]);
});
